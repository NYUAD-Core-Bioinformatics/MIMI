<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workflow &mdash; Mass Spectrometry Tool 1.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Architecture Design" href="architecture.html" />
    <link rel="prev" title="MIMI Documentation" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Mass Spectrometry Tool
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Workflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#basic-overview">Basic Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#database-preparation">1. Database Preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cache-creation">2. Cache Creation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sample-analysis">3. Sample Analysis</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#step1-database-preparation">Step1: Database Preparation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#database-sources">Database Sources</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mass-range-filtering">Mass Range Filtering</a></li>
<li class="toctree-l3"><a class="reference internal" href="#database-preparation-example">Database Preparation Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#step2-cache-creation">Step2: Cache Creation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#isotope-configuration">Isotope Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-label-option-for-stable-isotope-labeling">The –label Option for Stable Isotope Labeling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#verify-cache">Verify Cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="#computing-molecular-abundances">Computing Molecular abundances</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#step3-sample-analysis">Step3: Sample Analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mass-spectrometry-data-input-format">Mass spectrometry data input format</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ppm-thresholds">PPM Thresholds</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multiple-cache-analysis">Multiple Cache Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#batch-processing">Batch Processing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#results-format">Results Format</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#comprehensive-analysis-runs">Comprehensive Analysis Runs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#plotting-the-results">Plotting the results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#complete-example">Complete Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_reference.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="mimi_package.html">mimi package</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Mass Spectrometry Tool</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Workflow</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/workflow.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="workflow">
<h1>Workflow<a class="headerlink" href="#workflow" title="Permalink to this headline"></a></h1>
<p>MIMI is a tool that identifies small molecules present in mass spectrometry datasets by matching observed peaks against theoretical masses of known compounds and and verifies the assigments using fine-structure isotope patterns.</p>
<section id="installation">
<span id="id1"></span><h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline"></a></h2>
<p>MIMI can be installed using conda, which is the recommended method as it handles all dependencies automatically:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ conda install -c conda-forge mimi
</pre></div>
</div>
<p>Alternatively, you can install from source if you need the latest development version:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/NYUAD-Core-Bioinformatics/MIMI.git
$ cd MIMI
$ pip install .
</pre></div>
</div>
<p>MIMI has the following requirements and dependencies:</p>
<ul class="simple">
<li><p>Python v3 or above</p></li>
<li><p>numpy</p></li>
<li><p>pandas</p></li>
<li><p>json5</p></li>
<li><p>urllib3</p></li>
<li><p>tqdm</p></li>
<li><p>requests</p></li>
</ul>
</section>
<section id="basic-overview">
<h2>Basic Overview<a class="headerlink" href="#basic-overview" title="Permalink to this headline"></a></h2>
<p>A full MIMI analysis involves three steps:</p>
<section id="database-preparation">
<h3>1. Database Preparation<a class="headerlink" href="#database-preparation" title="Permalink to this headline"></a></h3>
<p>Choose a reference compound database and prepare a tab-delimited database file for input to MIMI.</p>
<ul class="simple">
<li><p>Minimally, must contain three columns with these headers: CF (chemical formula), ID (compound ID), and Name (compound name)</p></li>
</ul>
<ul>
<li><p>Select from KEGG, HMDB, or other publicly available sources, or create a custom database with specific compounds of interest</p>
<blockquote>
<div><ul class="simple">
<li><p>For KEGG and HMDB, use a MIMI helper script to extract compounds by ID or filtered by mass range</p></li>
<li><p>For custom metabolite lists, use the commandline tool provided here to generate pseudo-IDs for compounds with no IDs</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<p>See for more details: <a class="reference internal" href="#id2"><span class="std std-ref">Step1: Database Preparation</span></a>, <a class="reference internal" href="#database-sources"><span class="std std-ref">Database Sources</span></a>, <a class="reference internal" href="#mass-range-filtering"><span class="std std-ref">Mass Range Filtering</span></a>, <a class="reference internal" href="#database-preparation-example"><span class="std std-ref">Database Preparation Example</span></a></p>
</section>
<section id="cache-creation">
<h3>2. Cache Creation<a class="headerlink" href="#cache-creation" title="Permalink to this headline"></a></h3>
<p>Generate precomputed molecular masses and fine-structure isotope patterns for all compounds in your database.</p>
<ul>
<li><p>Cache creation is essential for MIMI analysis and improves run time performance</p></li>
<li><p>A separate cache is needed for each combination of database and atomic isotope ratios (natural abundance or labeled)</p>
<blockquote>
<div><ul class="simple">
<li><p>Cache contents can be inspected using <cite>mimi_cache_dump</cite> to ensure everything was processed correctly</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<p>See for more details: <a class="reference internal" href="#step2-cache-creation"><span class="std std-ref">Step2: Cache Creation</span></a>, <a class="reference internal" href="#ppm-thresholds"><span class="std std-ref">PPM Thresholds</span></a>, <a class="reference internal" href="#isotope-configuration"><span class="std std-ref">Isotope Configuration</span></a>, <a class="reference internal" href="#verify-cache"><span class="std std-ref">Verify Cache</span></a></p>
</section>
<section id="sample-analysis">
<h3>3. Sample Analysis<a class="headerlink" href="#sample-analysis" title="Permalink to this headline"></a></h3>
<p>Compare mass spectrometry data against precomputed molecular masses for a reference compound database.</p>
<ul class="simple">
<li><p>Analyze peak lists in <cite>.asc</cite> format, which should contain mass, intensity, and resolution columns</p></li>
<li><p>Find peak matches for monoisotopic mass and molecular variants for fine-structure isotope patterns</p></li>
<li><p>Simultaneously analyze multiple cache and sample files to identify metabolites with different isotope abundances</p></li>
<li><p>The output is a TSV file containing detailed information about all matched compounds</p></li>
<li><p>Explore the effect of different error thresholds for both mass matching (-p) and isotope pattern verification (-vp) using the script template provided here</p></li>
<li><p>Use the script template provided here to plot the number of metabolites and molecular variants identified using different error thresholds</p></li>
</ul>
<p>See for more details: <a class="reference internal" href="#step3-sample-analysis"><span class="std std-ref">Step3: Sample Analysis</span></a>, <a class="reference internal" href="#input-file-format"><span class="std std-ref">Mass spectrometry data input format</span></a>, <a class="reference internal" href="#multiple-cache-analysis"><span class="std std-ref">Multiple Cache Analysis</span></a>, <a class="reference internal" href="#batch-processing"><span class="std std-ref">Batch Processing</span></a>, <a class="reference internal" href="#results-format"><span class="std std-ref">Results Format</span></a>, <a class="reference internal" href="#comprehensive-analysis-runs"><span class="std std-ref">Comprehensive Analysis Runs</span></a></p>
</section>
</section>
<section id="step1-database-preparation">
<span id="id2"></span><h2>Step1: Database Preparation<a class="headerlink" href="#step1-database-preparation" title="Permalink to this headline"></a></h2>
<p>MIMI provides flexible options for preparing your compound database. You can either use established databases (KEGG or HMDB) or create a custom database. The choice depends on your research needs:</p>
<section id="database-sources">
<span id="id3"></span><h3>Database Sources<a class="headerlink" href="#database-sources" title="Permalink to this headline"></a></h3>
<ol class="arabic simple">
<li><p><strong>KEGG Database</strong>: Best for general biological samples</p></li>
</ol>
<ul class="simple">
<li><p>Comprehensive compound coverage</p></li>
<li><p>Integrated pathway information</p></li>
<li><p>Access via <cite>REST API &lt;https://www.kegg.jp/kegg/rest/keggapi.html&gt;</cite></p></li>
<li><p>Suitable for broad metabolomics studies</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ mimi_kegg_extract --help
usage: mimi_kegg_extract [-h] [-l MIN_MASS] [-u MAX_MASS] [-i COMPOUND_IDS] [-o OUTPUT] [-b BATCH_SIZE]

Extract compound information from KEGG

options:
-h, --help            show this help message and exit
-l MIN_MASS, --min-mass MIN_MASS
                        Lower bound of molecular weight in Da
-u MAX_MASS, --max-mass MAX_MASS
                        Upper bound of molecular weight in Da
-i COMPOUND_IDS, --input COMPOUND_IDS
                        Input TSV file containing KEGG compound IDs
-o OUTPUT, --output OUTPUT
                        Output TSV file path (default: kegg_compounds.tsv)
-b BATCH_SIZE, --batch-size BATCH_SIZE
                        Number of compounds to process in each batch (default: 5)
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p><strong>HMDB Database</strong>: Optimal for human studies</p></li>
</ol>
<p>The <a class="reference external" href="https://hmdb.ca/">Human Metabolome Database</a> (HMDB) is a freely available electronic database containing detailed information about small molecule metabolites found in the human body.</p>
<ul class="simple">
<li><p>Human-specific metabolites</p></li>
<li><p>Best for clinical and biomedical research</p></li>
<li><p>Detailed metabolite annotations</p></li>
</ul>
<dl class="simple">
<dt>Description:</dt><dd><p>This tool extracts data from an XML file downloaded from the <a class="reference external" href="https://hmdb.ca/downloads">HMDB</a> and converts it to a TSV format that can be used with MIMI. It can filter metabolites by molecular weight range and validates chemical formulas to ensure compatibility with MIMI’s formula parser.</p>
</dd>
</dl>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ mimi_hmdb_extract --help
usage: mimi_hmdb_extract [-h] -x XML [-l MIN_MASS] [-u MAX_MASS] [-o OUTPUT]

Extract metabolite information from HMDB XML file

options:
-h, --help            show this help message and exit
-x XML, --xml XML     Path to HMDB metabolites XML file
-l MIN_MASS, --min-mass MIN_MASS
                        Lower bound of molecular weight in Da
-u MAX_MASS, --max-mass MAX_MASS
                        Upper bound of molecular weight in Da
-o OUTPUT, --output OUTPUT
                        Output TSV file path (default: metabolites.tsv)
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p><strong>Custom Database</strong>: Create your own list of compounds.</p></li>
</ol>
<p>Useful for:
- Working with novel compounds
- Focusing on specific compounds of interest
- Combining multiple data sources</p>
<p>MIMI relies on the unique identifiers in the “ID” column of a database file for its analysis. If you have a list of compounds without standard identifiers, and you know (or suspect) the chemical formulas for them, you may use the commandline template provided here to automatically generate and add custom IDs to your list. Any custom database file must already contain CF and Name columns for your compounds (names are optional).</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ head data/processed/customDB.tsv
CF              Name
C21H28N7O14P2   NAD+
C21H29N7O17P3   NADP+
C9H14N2O12P2    UDP
C27H33N9O15P2   FAD
C8H10NO6P1      Pyridoxal phosphate
C15H22N6O5S1    S-Adenosyl-L-methionine
C14H20N6O5S     S-Adenosyl-L-homocysteine
C23H38N7O17P3S  Acetyl-CoA
C34H32FeN4O4    Heme
</pre></div>
</div>
<p>The following command reads from <cite>customDB.tsv</cite>, adds custom IDs to the TSV file by combining a timestamp with row numbers, and writes to <cite>customDBwithID.tsv</cite>, both located in the data/processed directory.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ timestamp=$(date +&quot;%Y%m%d%H%M%S&quot;); awk -v ts=&quot;$timestamp&quot; &#39;BEGIN {OFS=&quot;\t&quot;} NR==1 {print $1, &quot;ID&quot;, $2} NR&gt;1 {printf &quot;%s\tMIMI_%s_%04d\t%s\n&quot;, $1, ts, NR-1, $2}&#39; data/processed/customDB.tsv | sed &#39;s/\r//&#39; &gt; data/processed/customDBwithID.tsv
</pre></div>
</div>
<p>The output file (<cite>customDBwithID.tsv</cite>) contains the original chemical formula (CF) and compound name, with an additional ID column.
Each ID is prefixed with <cite>MIMI_</cite> followed by a timestamp and a sequential number, ensuring unique identifiers for each compound.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ head data/processed/customDBwithID.tsv
CF              ID                          Name
C21H28N7O14P2   MIMI_20250603132713_0001    NAD+
C21H29N7O17P3   MIMI_20250603132713_0002    NADP+
C9H14N2O12P2    MIMI_20250603132713_0003    UDP
C27H33N9O15P2   MIMI_20250603132713_0004    FAD
C8H10NO6P1      MIMI_20250603132713_0005    Pyridoxal
C15H22N6O5S1    MIMI_20250603132713_0006    S-Adenosyl-L-methionine
C14H20N6O5S     MIMI_20250603132713_0007    S-Adenosyl-L-homocysteine
C23H38N7O17P3S  MIMI_20250603132713_0008    Acetyl-CoA
C34H32FeN4O4    MIMI_20250603132713_0009    Heme
</pre></div>
</div>
</section>
<section id="mass-range-filtering">
<span id="id4"></span><h3>Mass Range Filtering<a class="headerlink" href="#mass-range-filtering" title="Permalink to this headline"></a></h3>
<p>All database preparation methods support mass filtering to focus on your range of interest:</p>
<ul class="simple">
<li><p><cite>-l</cite>: Lower mass limit</p>
<ul>
<li><p>Excludes compounds below specified mass</p></li>
<li><p>Example: <cite>-l 40</cite> removes compounds &lt; 40 Da</p></li>
<li><p>Useful for filtering out small molecules/contaminants</p></li>
</ul>
</li>
<li><p><cite>-u</cite>: Upper mass limit</p>
<ul>
<li><p>Excludes compounds above specified mass</p></li>
<li><p>Example: <cite>-u 1000</cite> removes compounds &gt; 1000 Da</p></li>
<li><p>Helps focus on relevant mass ranges</p></li>
</ul>
</li>
</ul>
<p>Example: <cite>-l 40 -u 1000</cite> retains only compounds between 40-1000 Da.</p>
</section>
<section id="database-preparation-example">
<span id="id5"></span><h3>Database Preparation Example<a class="headerlink" href="#database-preparation-example" title="Permalink to this headline"></a></h3>
<p>Here’s how to prepare databases from different sources using a typical mass range of 40-1000 Da (based on common MS data ranges):</p>
<ol class="arabic">
<li><p><strong>From KEGG</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Extract compounds
$mimi_kegg_extract -l 40 -u 1000 -o data/processed/kegg_compounds_40_1000Da.tsv

# Count the number of compounds
$wc -l data/processed/kegg_compounds_40_1000Da.tsv
16090 data/processed/kegg_compounds_40_1000Da.tsv

# Show the first 10 compounds
$head -10 data/processed/kegg_compounds_40_1000Da.tsv
CF              ID      Name
C44H52N8O10     C11617  Pristinamycin IC
C10H16          C20230  (+)-Sabinene
C6H14           C11271  n-Hexane
C10H6O2         C14783  1,2-Naphthoquinone
C8H14N2O2       C07841  Levetiracetam
C14H16ClN3O4S2  C12685  Cyclothiazide
C26H34O3        C14259  Stanolone benzoate
C5H5N5O2        C22500  2,8-Dihydroxyadenine
C17H22O5        C09536  Pyrethrosin


# Sort and remove duplicates
$ { head -n 1 data/processed/kegg_compounds_40_1000Da.tsv; tail -n +2 data/processed/kegg_compounds_40_1000Da.tsv | sort -k2,2; } &gt; data/processed/kegg_compounds_40_1000Da_sorted.tsv
$ awk &#39;!seen[$1]++&#39; data/processed/kegg_compounds_40_1000Da_sorted.tsv &gt; data/processed/kegg_compounds_40_1000Da_sorted_uniq.tsv

$ wc -l data/processed/kegg_compounds_40_1000Da_sorted_uniq.tsv
8530 data/processed/kegg_compounds_40_1000Da_sorted_uniq.tsv
</pre></div>
</div>
</li>
<li><p><strong>From HMDB</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># First download the HMDB XML file, then extract compounds</span>
<span class="n">mimi_hmdb_extract</span> <span class="o">-</span><span class="n">l</span> <span class="mi">40</span> <span class="o">-</span><span class="n">u</span> <span class="mi">1000</span> <span class="o">-</span><span class="n">x</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">hmdb_metabolites</span><span class="o">.</span><span class="n">xml</span> <span class="o">-</span><span class="n">o</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">hmdb_compounds_40_1000Da</span><span class="o">.</span><span class="n">tsv</span>

<span class="c1"># Sort and remove duplicates</span>
<span class="p">{</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">1</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">hmdb_compounds_40_1000Da</span><span class="o">.</span><span class="n">tsv</span><span class="p">;</span> <span class="n">tail</span> <span class="o">-</span><span class="n">n</span> <span class="o">+</span><span class="mi">2</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">hmdb_compounds_40_1000Da</span><span class="o">.</span><span class="n">tsv</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">k2</span><span class="p">,</span><span class="mi">2</span><span class="p">;</span> <span class="p">}</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">hmdb_compounds_40_1000Da_sorted</span><span class="o">.</span><span class="n">tsv</span>
<span class="n">awk</span> <span class="s1">&#39;!seen[$1]++&#39;</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">hmdb_compounds_40_1000Da_sorted</span><span class="o">.</span><span class="n">tsv</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">hmdb_compounds_40_1000Da_sorted_uniq</span><span class="o">.</span><span class="n">tsv</span>
</pre></div>
</div>
</li>
</ol>
<p>The output in both cases will be a TSV file containing:</p>
<ul class="simple">
<li><p>Chemical formulas (CF)</p></li>
<li><p>Compound IDs (ID)</p></li>
<li><p>Compound names (Name)</p></li>
<li><p>Only compounds within the specified mass range</p></li>
</ul>
<p>This mass range we used is suitable for typical MS data, as shown in this example data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ head -4 data/processed/testdata1.asc
43.16184    1089317  0.00003
43.28766    1115802  0.00003
43.28946    1226947  0.00003
43.30269    1107425  0.00005

$head -4  data/processed/testdata2.asc
43.16185    991278.47   0.00003
43.28765    1093485.96  0.00003
43.28946    1104252.3   0.00003
43.3027     1018831     0.00005



$tail  -4  data/processed/testdata1.asc
999.50487   2941816 0.02121
999.52689   2547575 0.01782
999.90084   1347088 0.00892
999.99347   2578292 0.00277

$tail  -4  data/processed/testdata2.asc
999.50507   2794725.2   0.02121
999.52709   2343769     0.01782
999.90104   1225850.08  0.00892
999.99367   2552509.08  0.00277
</pre></div>
</div>
</section>
</section>
<section id="step2-cache-creation">
<span id="id6"></span><h2>Step2: Cache Creation<a class="headerlink" href="#step2-cache-creation" title="Permalink to this headline"></a></h2>
<p>Create cache files to store precomputed molecular masses and isotope patterns. This step is essential for:</p>
<ul>
<li><p>Fast analysis performance</p></li>
<li><p>Initial setup before any analysis</p></li>
<li><p>Updates when:</p>
<blockquote>
<div><ul class="simple">
<li><p>Database changes</p></li>
<li><p>Isotope settings change</p></li>
<li><p>New project begins</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ mimi_cache_create  --help
usage: mimi_cache_create [-h] [-l JSON] [-n CUTOFF] -d DBTSV [DBTSV ...] -i {pos,neg} -c DBBINARY

Molecular Isotope Mass Identifier

options:
-h, --help            show this help message and exit
-l JSON, --label JSON
                        Labeled atoms
-n CUTOFF, --noise CUTOFF
                        Threshold for filtering molecular isotope variants with relative abundance below CUTOFF w.r.t. the monoisotopic mass (defaults to 1e-5)
-d DBTSV [DBTSV ...], --dbfile DBTSV [DBTSV ...]
                        File(s) with list of compounds
-i {pos,neg}, --ion {pos,neg}
                        Ionisation mode
-c DBBINARY, --cache DBBINARY
                        Binary DB output file (if not specified, will use base name from JSON file)
</pre></div>
</div>
<p>For natural abundance compounds, use:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ mimi_cache_create -i neg -d data/processed/kegg_compounds_40_1000Da_sorted_uniq.tsv -c outdir/nat
</pre></div>
</div>
<p>Expected Output: A binary cache file containing precomputed masses and isotope patterns for all compounds in your database.
This file will be used for fast matching during analysis.</p>
<section id="isotope-configuration">
<span id="id7"></span><h3>Isotope Configuration<a class="headerlink" href="#isotope-configuration" title="Permalink to this headline"></a></h3>
<p>MIMI uses atomic weights and natural isotope abundances from the National Institute of Standards and Technology (NIST). The original data, sourced from the <a class="reference external" href="https://www.nist.gov/pml/atomic-weights-and-isotopic-compositions-relative-atomic-masses">NIST Atomic Weights database</a>, was converted from plain text to JSON format for easier processing and is distributed with MIMI as <a class="reference external" href="https://raw.githubusercontent.com/NYUAD-Core-Bioinformatics/MIMI/refs/heads/main/mimi/data/natural_isotope_abundance_NIST.json">natural_isotope_abundance_NIST.json</a>. This file serves as the foundation for all isotopic calculations.</p>
<p>For each element in <cite>natural_isotope_abundance_NIST.json</cite>, it provides detailed information about all its naturally occurring isotopes, including:</p>
<ol class="arabic simple">
<li><p><strong>Element Organization</strong>: Data is organized by element symbol (e.g., “H”, “C”, “O”, etc.)</p></li>
<li><p><strong>Isotope Information</strong>: For each isotope of an element, the file includes:</p>
<ul class="simple">
<li><p><cite>periodic_number</cite>: The atomic number of the element</p></li>
<li><p><cite>element_symbol</cite>: The chemical symbol of the element</p></li>
<li><p><cite>nominal_mass</cite>: The mass number (number of protons + neutrons)</p></li>
<li><p><cite>exact_mass</cite>: The precise atomic mass in atomic mass units (u)</p></li>
<li><p><cite>isotope_abundance</cite>: The relative abundance of the isotope in nature</p></li>
</ul>
</li>
</ol>
<p>Example entry for Carbon (C) in <a class="reference external" href="https://raw.githubusercontent.com/NYUAD-Core-Bioinformatics/MIMI/refs/heads/main/mimi/data/natural_isotope_abundance_NIST.json">natural_isotope_abundance_NIST.json</a>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&quot;C&quot;: [
    {
        &quot;periodic_number&quot;: 6,
        &quot;element_symbol&quot;: &quot;C&quot;,
        &quot;nominal_mass&quot;: 12,
        &quot;exact_mass&quot;: 12.0,
        &quot;isotope_abundance&quot;: 0.9893
    },
    {
        &quot;periodic_number&quot;: 6,
        &quot;element_symbol&quot;: &quot;C&quot;,
        &quot;nominal_mass&quot;: 13,
        &quot;exact_mass&quot;: 13.00335483507,
        &quot;isotope_abundance&quot;: 0.0107
    }
]
</pre></div>
</div>
<p>This data is used for:</p>
<ul class="simple">
<li><p>Calculating exact molecular masses</p></li>
<li><p>Determining molecular isotope patterns</p></li>
<li><p>Computing Molecular abundances</p></li>
</ul>
</section>
<section id="the-label-option-for-stable-isotope-labeling">
<span id="label-option"></span><h3>The –label Option for Stable Isotope Labeling<a class="headerlink" href="#the-label-option-for-stable-isotope-labeling" title="Permalink to this headline"></a></h3>
<p>For samples with stable isotope labeling, you can override the natural abundance values using the <cite>–label</cite> (<cite>-l</cite>) option with a custom JSON file. This is particularly useful for experimental studies using stable isotope labeling with:</p>
<ul class="simple">
<li><p>Carbon (13C)</p></li>
<li><p>Hydrogen (2H)</p></li>
<li><p>Nitrogen (15N)</p></li>
<li><p>Oxygen (17O, 18O)</p></li>
<li><p>Sulfur (33S, 34S)</p></li>
</ul>
<p>Key points about the <cite>–label</cite> option:</p>
<ul class="simple">
<li><p>Only specify the elements you want to override</p></li>
<li><p>Isotope abundances must sum to 1.0 (MIMI verifies this)</p></li>
</ul>
<p>Example: For 95% 13C labeling, you can use the provided configuration file at <a class="reference external" href="https://raw.githubusercontent.com/NYUAD-Core-Bioinformatics/MIMI/refs/heads/main/data/processed/C13_95.json">C13_95.json</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">C13_95</span><span class="o">.</span><span class="n">json</span>
<span class="p">{</span>
  <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;periodic_number&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
      <span class="s2">&quot;element_symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span>
      <span class="s2">&quot;nominal_mass&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
      <span class="s2">&quot;exact_mass&quot;</span><span class="p">:</span> <span class="mf">12.000</span><span class="p">,</span>
      <span class="s2">&quot;isotope_abundance&quot;</span><span class="p">:</span> <span class="mf">0.05</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;periodic_number&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
      <span class="s2">&quot;element_symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span>
      <span class="s2">&quot;nominal_mass&quot;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
      <span class="s2">&quot;exact_mass&quot;</span><span class="p">:</span> <span class="mf">13.00335484</span><span class="p">,</span>
      <span class="s2">&quot;isotope_abundance&quot;</span><span class="p">:</span> <span class="mf">0.95</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For C13-95% labeled compounds, create a cache with the isotope configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mimi_cache_create</span> <span class="o">-</span><span class="n">i</span> <span class="n">neg</span> <span class="o">-</span><span class="n">l</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">C13_95</span><span class="o">.</span><span class="n">json</span> <span class="o">-</span><span class="n">d</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">kegg_compounds_40_1000Da_sorted_uniq</span><span class="o">.</span><span class="n">tsv</span> <span class="o">-</span><span class="n">c</span> <span class="n">outdir</span><span class="o">/</span><span class="n">C13_95</span>
</pre></div>
</div>
<p>Expected Output: A cache file with isotope patterns adjusted for C13-95% labeling.</p>
<p>Use this when analyzing labeled samples.</p>
</section>
<section id="verify-cache">
<span id="id9"></span><h3>Verify Cache<a class="headerlink" href="#verify-cache" title="Permalink to this headline"></a></h3>
<p>Before proceeding with analysis, it’s good practice to verify your cache contents. This helps ensure that the compounds and their isotope patterns were processed correctly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mimi_cache_dump</span> <span class="n">outdir</span><span class="o">/</span><span class="n">nat</span><span class="o">.</span><span class="n">pkl</span> <span class="o">-</span><span class="n">n</span> <span class="mi">2</span> <span class="o">-</span><span class="n">i</span> <span class="mi">2</span>
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ mimi_cache_dump outdir/nat.pkl -n 2 -i 2
# Cache Metadata:
# Creation Date: 2025-06-03T14:47:08
# MIMI Version: 1.0.0

# Creation Parameters:
# Full Command: /Users/aaa/anaconda3/envs/v_mimi/bin/mimi_cache_create -i neg -d data/processed/kegg_compounds_40_1000Da_sorted_uniq.tsv -c outdir/nat
# Ionization Mode: neg
# Labeled Atoms File: None
# Compound DB Files: data/processed/kegg_compounds_40_1000Da_sorted_uniq.tsv
# Cache Output File: outdir/nat.pkl
# Isotope Data File: mimi/data/natural_isotope_abundance_NIST.json

============================================================
Compound ID:      C00002
Name:             ATP
Formula:          [12]C10[1]H16[14]N5[16]O13[31]P3
Mono-isotopic:    Yes (most abundant isotope)
Mass:             505.988470
Relative Abund:   1.000000 (reference)
------------------------------------------------------------
ISOTOPE VARIANTS:
Variant #1:
Formula:        [12]C9 [13]C1 [1]H16 [14]N5 [16]O13 [31]P3
Mono-isotopic:  No (isotope variant)
Mass:           506.991825
Relative Abund: 0.108157 (expected)
------------------------------------------------------------
Variant #2:
Formula:        [12]C10 [1]H16 [14]N5 [16]O12 [18]O1 [31]P3
Mono-isotopic:  No (isotope variant)
Mass:           507.992715
Relative Abund: 0.026715 (expected)
------------------------------------------------------------

============================================================
Compound ID:      C00003
Name:             NAD+
Formula:          [12]C21[1]H28[14]N7[16]O14[31]P2
Mono-isotopic:    Yes (most abundant isotope)
Mass:             663.109671
Relative Abund:   1.000000 (reference)
------------------------------------------------------------
ISOTOPE VARIANTS:
Variant #1:
Formula:        [12]C20 [13]C1 [1]H28 [14]N7 [16]O14 [31]P2
Mono-isotopic:  No (isotope variant)
Mass:           664.113026
Relative Abund: 0.227130 (expected)
------------------------------------------------------------
Variant #2:
Formula:        [12]C21 [1]H28 [14]N7 [16]O13 [18]O1 [31]P2
Mono-isotopic:  No (isotope variant)
Mass:           665.113916
Relative Abund: 0.028770 (expected)
------------------------------------------------------------
</pre></div>
</div>
</section>
<section id="computing-molecular-abundances">
<h3>Computing Molecular abundances<a class="headerlink" href="#computing-molecular-abundances" title="Permalink to this headline"></a></h3>
<p>This guide explains how to calculate the relative abundance of a specific isotopologue in a molecule, accounting for both the fractional abundance of minor isotopes and their combinatorial placement within the molecule.</p>
<p><strong>Key Concepts:</strong></p>
<ul class="simple">
<li><p><strong>Isotopologue:</strong> A molecule variant with specific isotopic composition.</p></li>
<li><p><strong>Fractional Abundance:</strong> The ratio of a minor isotope’s natural abundance to the most abundant isotope of that element.</p></li>
<li><p><strong>Combinatorial Factor:</strong> The number of ways minor isotopes can be arranged within the molecule (binomial coefficient).</p></li>
<li><p><strong>Relative Abundance:</strong> The final likelihood of observing this isotopologue in mass spectrometry.</p></li>
</ul>
<p><strong>Algorithm:</strong></p>
<ol class="arabic">
<li><p><strong>Initialize</strong> the relative abundance to 1.</p></li>
<li><p><strong>For each isotope in the molecule</strong>:
- If it is a <em>minor isotope</em> (not the most abundant isotope for its element):</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>Compute the <strong>abundance factor</strong>:</p></li>
</ol>
<div class="math notranslate nohighlight">
\[\text{abundance_factor} = \left(\frac{\text{isotope_abundance}}{\text{highest_abundance}}\right)^{\text{count}}\]</div>
<ol class="loweralpha simple" start="2">
<li><p>Update the relative abundance:</p></li>
</ol>
<div class="math notranslate nohighlight">
\[\text{relative_abundance} *= \text{abundance_factor} \times \text{total_atoms_of_element}\]</div>
</div></blockquote>
<ul class="simple">
<li><p>If it is the <strong>major isotope</strong> (most abundant), it does not affect the calculation (factor = 1).</p></li>
</ul>
</li>
<li><p>The <strong>final relative abundance</strong> is the product of all these factors.</p></li>
</ol>
<p>Let’s work through a detailed example calculation for the following molecular isotope</p>
<p><strong>Molecular Composition:</strong></p>
<ul class="simple">
<li><p><strong>Formula:</strong> [12]C19 [13]C2 [1]H28 [14]N7 [16]O13 [17]O1 [31]P2</p></li>
<li><p><strong>Carbon:</strong> 21 atoms total (Nineteen [12]C and two [13]C)</p></li>
<li><p><strong>Hydrogen:</strong> 28 atoms (Twenty-eight [1]H only)</p></li>
<li><p><strong>Nitrogen:</strong> 7 atoms (Seven [14]N only)</p></li>
<li><p><strong>Oxygen:</strong> 14 atoms total (Thirteen [16]O and one [17]O)</p></li>
<li><p><strong>Phosphorus:</strong> 2 atoms (Two [31]P only)</p></li>
</ul>
<p><strong>Natural Abundances:</strong></p>
<ul class="simple">
<li><p>13C: 0.0107 (minor),  12C: 0.9893 (major)</p></li>
<li><p>17O: 0.00038 (minor), 16O: 0.99757 (major)</p></li>
</ul>
<p><strong>Step 1: Calculate abundance factors</strong></p>
<ul>
<li><p>For 13C:</p>
<div class="math notranslate nohighlight">
\[\left(\frac{0.0107}{0.9893}\right)^2  = (0.0108)^2  = 0.00011664\]</div>
</li>
<li><p>For 17O:</p>
<div class="math notranslate nohighlight">
\[\frac{0.00038}{0.99757} \approx 0.000381\]</div>
</li>
</ul>
<p><strong>Step 2: Compute final relative abundance</strong></p>
<ul>
<li><p>Final relative abundance:</p>
<div class="math notranslate nohighlight">
\[(0.00011664 \times 21) \times  (0.000381 \times 14) = 0.00001306\]</div>
</li>
</ul>
<p>Thus, the <strong>relative abundance</strong> of the isotopologue <strong>[12]C19 [13]C2 [1]H28 [14]N7 [16]O13 [17]O1 [31]P2</strong> is approximately <strong>0.000013</strong> which is the same as the result from the MIMI software.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ mimi_cache_dump outdir/nat.pkl -n 2 -i 30 | grep -A5  &quot;Variant #26:&quot;
Variant #26:
Formula:        [12]C19 [13]C2 [1]H28 [14]N7 [16]O13 [17]O1 [31]P2
Mono-isotopic:  No (isotope variant)
Mass:           666.120598
Relative Abund: 0.000013 (expected)
</pre></div>
</div>
</section>
</section>
<section id="step3-sample-analysis">
<span id="id10"></span><h2>Step3: Sample Analysis<a class="headerlink" href="#step3-sample-analysis" title="Permalink to this headline"></a></h2>
<p>After preparing your database and creating the cache files, you can analyze your mass spectrometry data using the mimi_mass_analysis command. This command matches your experimental peak lists against the precomputed theoretical masses and isotope patterns stored in the cache files.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ mimi_mass_analysis --help
usage: mimi_mass_analysis [-h] -p PPM -vp VPPM -c DBBINARY [DBBINARY ...] -s SAMPLE [SAMPLE ...] -o OUTPUT

Molecular Isotope Mass Identifier

options:
-h, --help            show this help message and exit
-p PPM, --ppm PPM     Parts per million for the mono isotopic mass of chemical formula
-vp VPPM              Parts per million for verification of isotopes
-c DBBINARY [DBBINARY ...], --cache DBBINARY [DBBINARY ...]
                        Binary DB input file(s)
-s SAMPLE [SAMPLE ...], --sample SAMPLE [SAMPLE ...]
                        Input sample file
-o OUTPUT, --output OUTPUT
                        Output file
</pre></div>
</div>
<p>The command requires two main inputs:</p>
<ul class="simple">
<li><p>One or more cache files (.pkl format) specified with –cache (-c) that contain the theoretical masses and patterns to match against</p></li>
<li><p>One or more sample files (.asc format) specified with –sample (-s) containing your experimental peak lists</p></li>
</ul>
<p>A key feature of MIMI is its flexibility in handling multiple datasets simultaneously. You can:</p>
<ul class="simple">
<li><p>Compare a single sample against multiple cache files with different isotope configurations</p></li>
<li><p>Analyze multiple samples against a single cache file</p></li>
<li><p>Process any combination of samples and cache files in parallel</p></li>
</ul>
<p>This versatility makes MIMI particularly valuable for:</p>
<ul class="simple">
<li><p>Analyzing samples containing isotope-labeled standards</p></li>
<li><p>Comparing time series measurements</p></li>
<li><p>Contrasting treated vs untreated samples</p></li>
<li><p>Examining samples under different experimental conditions</p></li>
</ul>
<section id="mass-spectrometry-data-input-format">
<span id="input-file-format"></span><h3>Mass spectrometry data input format<a class="headerlink" href="#mass-spectrometry-data-input-format" title="Permalink to this headline"></a></h3>
<p>MIMI accepts mass spectrometry data in .asc format. Each line contains three columns:</p>
<ul class="simple">
<li><p>Mass (m/z)</p></li>
<li><p>Intensity</p></li>
<li><p>Resolution</p></li>
</ul>
<p>Example input file (data/processed/testdata1.asc):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ head -4 data/processed/testdata1.asc
43.16184    1089317 0.00003
43.28766    1115802 0.00003
43.28946    1226947 0.00003
43.30269    1107425 0.00005
</pre></div>
</div>
<p>Now you’re ready to analyze your mass spectrometry data. The analysis command matches your sample masses against the precomputed database and verifies matches using isotope patterns</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ mimi_mass_analysis -p 0.5 -vp 0.5 -c outdir/nat outdir/C13_95 -s data/processed/testdata2.asc -o outdir/results.tsv
</pre></div>
</div>
<p>Key parameters:</p>
<ul class="simple">
<li><p><cite>-p 0.5</cite>: Mass matching tolerance (0.5 ppm) - controls how close the observed mass needs to be to the theoretical mass</p></li>
<li><p><cite>-vp 0.5</cite>: Isotope pattern verification tolerance (0.5 ppm) - controls how well the isotope pattern must match</p></li>
<li><p><cite>-c</cite>: Cache files to use (can specify multiple for comparing natural and labeled patterns)</p></li>
<li><p><cite>-s</cite>: Sample file to analyze (in .asc format)</p></li>
<li><p><cite>-o</cite>: Output file for results</p></li>
</ul>
</section>
<section id="ppm-thresholds">
<span id="id11"></span><h3>PPM Thresholds<a class="headerlink" href="#ppm-thresholds" title="Permalink to this headline"></a></h3>
<p>The PPM threshold affects match precision and reliability:</p>
<ul class="simple">
<li><p><strong>&lt;0.5 ppm</strong>: Excellent mass accuracy, high confidence in exact mass identification</p></li>
<li><p><strong>0.5 - 1 ppm</strong>: Good mass accuracy, reliable identification with isotope pattern validation</p></li>
<li><p><strong>1-2 ppm</strong>: Lower mass accuracy, less reliable identifications</p></li>
<li><p><strong>&gt;2 ppm</strong>: Not recommended for high-resolution mass spectrometry data</p></li>
</ul>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># High confidence analysis
$ mimi_mass_analysis -p 0.5 -vp 0.5 -c outdir/nat -s data/processed/testdata2.asc -o outdir/results_excellent.tsv

# Standard confidence analysis
$ mimi_mass_analysis -p 1.0 -vp 1.0 -c outdir/nat -s data/processed/testdata2.asc -o outdir/results_good.tsv
</pre></div>
</div>
</section>
<section id="multiple-cache-analysis">
<span id="id12"></span><h3>Multiple Cache Analysis<a class="headerlink" href="#multiple-cache-analysis" title="Permalink to this headline"></a></h3>
<p>You can analyze your samples against multiple caches simultaneously. This is useful when comparing natural and labeled patterns:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mimi_mass_analysis -p 0.5 -vp 0.5 -c outdir/nat outdir/C13_95 -s data/processed/testdata2.asc -o outdir/results.tsv
</pre></div>
</div>
</section>
<section id="batch-processing">
<span id="id13"></span><h3>Batch Processing<a class="headerlink" href="#batch-processing" title="Permalink to this headline"></a></h3>
<p>MIMI supports processing multiple samples in a single run. This is useful for analyzing replicates or comparing different conditions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mimi_mass_analysis -p 0.5 -vp 0.5 -c outdir/nat -s data/processed/testdata1.asc data/processed/testdata2.asc -o outdir/batch_results.tsv
</pre></div>
</div>
</section>
<section id="results-format">
<span id="id14"></span><h3>Results Format<a class="headerlink" href="#results-format" title="Permalink to this headline"></a></h3>
<p>The output TSV file contains these columns:</p>
<ul class="simple">
<li><p><strong>CF</strong>: Chemical formula of the matched compound</p></li>
<li><p><strong>ID</strong>: Compound identifier from the original database</p></li>
<li><p><strong>Name</strong>: Compound name</p></li>
<li><p><strong>C</strong>: Number of carbon atoms</p></li>
<li><p><strong>H</strong>: Number of hydrogen atoms</p></li>
<li><p><strong>N</strong>: Number of nitrogen atoms</p></li>
<li><p><strong>O</strong>: Number of oxygen atoms</p></li>
<li><p><strong>P</strong>: Number of phosphorus atoms</p></li>
<li><p><strong>S</strong>: Number of sulfur atoms</p></li>
<li><p><strong>nat</strong>: Calculated mass for natural abundance(User specified)</p></li>
<li><p><strong>C13_95</strong>: Calculated mass for C13-labeled (User specified)</p></li>
<li><p><strong>mass_measured</strong>: Observed mass in the sample</p></li>
<li><p><strong>error_ppm</strong>: Parts per million difference between calculated and observed mass</p></li>
<li><p><strong>intensity</strong>: Signal intensity in the sample</p></li>
<li><p><strong>iso_count</strong>: Number of isotopes detected</p></li>
</ul>
<p>Example output file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mimi_mass_analysis -g  -p 0.5 -vp 0.5 -c outdir/nat outdir/C13_95 -s data/processed/testdata2.asc -o outdir/results.tsv

$(head -4 outdir/results.tsv; cat   outdir/results.tsv | grep -A6  C00147)
Log file    /Users/aaa/test/log/results_20250603_145131.log
                                                                                                        data/processed/testdata2.asc
                                                                                                        nat                                                                  C13_95
CF         ID       Name               C   H   N   O   P   S   nat_mass            C13_95_mass          mass_measured       error_ppm               intensity    iso_count   mass_measured   error_ppm               intensity        iso_count
C5H5N5     C00147   Adenine            5   5   5   0   0   0   134.0472187163      139.06399291629998   134.04722           -0.009576476318665454   10030305.6   2           139.06396       0.2366989418442906      143680406.4      4
C5H9NO2    C00148   L-Proline          5   9   1   2   0   0   114.05605206664     119.07282626664002   114.05601           0.36882426880317554     18852508.02  3           119.0728        0.220593067653808       72633081.84      3
C4H6O5     C00149   (S)-Malate         4   6   0   5   0   0   133.01424682422999  137.02766618423      133.01424           0.05130450419853602     4229908.65   2           137.02769       -0.1738026391616008     2550057.38       1
C4H8N2O3   C00152   L-Asparagine       4   8   2   3   0   0   131.04621565841     135.05963501841      131.04617           0.34841456341916127     4418266.3    2           135.0596        0.2592810946979107      123609409.5      5
C6H6N2O    C00153   Nicotinamide       6   6   2   1   0   0   121.04073635481                          121.04075           -0.1127322124761087     640304.28    1
C4H9NO2S   C00155   L-Homocysteine     4   9   1   2   0   1   134.02812324104002  138.04154260104002   134.02816           -0.274263036027993      1882881.1    2           138.04156       -0.12604147747949546    554962.24        4
C7H6O3     C00156   4-Hydroxybenzoate  7   6   0   3   0   0   137.02441758509002                       137.02444           -0.16358332604462747    87231044.64  2
</pre></div>
</div>
</section>
</section>
<section id="comprehensive-analysis-runs">
<span id="id15"></span><h2>Comprehensive Analysis Runs<a class="headerlink" href="#comprehensive-analysis-runs" title="Permalink to this headline"></a></h2>
<p>MIMI provides a comprehensive analysis script that allows you to perform multiple analyses with different parameter combinations in a single run. This is particularly useful for:</p>
<ul class="simple">
<li><p>Testing different mass matching tolerances</p></li>
<li><p>Comparing isotope pattern verification thresholds</p></li>
<li><p>Analyzing multiple samples simultaneously</p></li>
<li><p>Generating results for different parameter combinations</p></li>
</ul>
<p>The comprehensive run script (<cite>run.sh</cite>) performs the following steps:</p>
<ol class="arabic simple">
<li><p><strong>Setup and Validation</strong>:</p>
<ul class="simple">
<li><p>Checks for required input and output directories</p></li>
<li><p>Creates the output directory if it doesn’t exist</p></li>
<li><p>Validates the input parameters</p></li>
</ul>
</li>
<li><p><strong>Cache Creation</strong>:</p>
<ul class="simple">
<li><p>Creates two cache files:</p>
<ul>
<li><p>Natural abundance cache (<cite>nat.pkl</cite>)</p></li>
<li><p>C13-95% labeled cache (<cite>C13_95.pkl</cite>)</p></li>
</ul>
</li>
<li><p>Uses the test database and C13-95% labeling configuration</p></li>
</ul>
</li>
<li><p><strong>Parameter Testing</strong>:</p>
<ul class="simple">
<li><p>Tests different combinations of parameters:</p>
<ul>
<li><p>Mass matching tolerance (p): 0.1, 0.5, 1.0 ppm</p></li>
<li><p>Isotope pattern verification (vp): 0.1, 0.5, 1.0 ppm</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Analysis Types</strong>:</p>
<ul class="simple">
<li><p><strong>Fixed vp Analysis</strong>: Varies mass matching tolerance while keeping isotope verification fixed at 0.5 ppm</p></li>
<li><p><strong>Fixed p Analysis</strong>: Varies isotope verification while keeping mass matching fixed at 0.5 ppm</p></li>
</ul>
</li>
</ol>
<p>Example Usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sh ./run.sh data/processed outdir
</pre></div>
</div>
<p>The script content:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

# Check if both output and data directories are provided as arguments
if [ $# -ne 2 ]; then
    echo &quot;Usage: $0 &lt;data_directory&gt; &lt;output_directory&gt;&quot;
    exit 1
fi

# Get directories from command line arguments
datadir=&quot;$1&quot;
outdir=&quot;$2&quot;

# Create output directory
mkdir -p &quot;$outdir&quot;

# Sort and remove duplicates from KEGG compounds file
cp &quot;$datadir/kegg_compounds_40_1000Da.tsv&quot; &quot;$outdir/testDB.tsv&quot;
{ head -n 1 &quot;$outdir/testDB.tsv&quot;; tail -n +2 &quot;$outdir/testDB.tsv&quot; | sort -k2,2; } &gt; &quot;$outdir/testDB_sorted.tsv&quot;
awk &#39;!seen[$1]++&#39; &quot;$outdir/testDB_sorted.tsv&quot; &gt; &quot;$outdir/testDB_sorted_uniq.tsv&quot;



# Create cache files in outdir and check for success
mimi_cache_create  -i neg   -d &quot;$outdir/testDB_sorted_uniq.tsv&quot;  -c &quot;$outdir/nat&quot;
mimi_cache_create  -i neg   -l &quot;$datadir/C13_95.json&quot; -d &quot;$outdir/testDB_sorted_uniq.tsv&quot;  -c &quot;$outdir/C13_95&quot;


if [ ! -f &quot;$outdir/nat.pkl&quot; ] || [ ! -f &quot;$outdir/C13_95.pkl&quot; ]; then
    echo &quot;Error: Failed to create cache files&quot;
    exit 1
fi

# Define test data files
test_files=(&quot;testdata1.asc&quot; &quot;testdata2.asc&quot;)

# Define parameter sets
p_values=(0.1 0.5 1)
vp_values=(0.1 0.5 1)

# Loop through each test file
for test_file in &quot;${test_files[@]}&quot;; do
    base_name=$(basename &quot;$test_file&quot; .asc)

    # Analysis for top graph (fixed vp=0.5, varying p)
    for p in &quot;${p_values[@]}&quot;; do
        p_str=$(echo $p | tr -d &#39;.&#39;)
        mimi_mass_analysis -p $p -vp 0.5 -c &quot;$outdir/nat&quot; &quot;$outdir/C13_95&quot; -s &quot;$datadir/$test_file&quot; -o &quot;$outdir/n${base_name}_p${p_str}_vp05_combined.tsv&quot;
    done

    # Analysis for bottom graph (fixed p=0.5, varying vp)
    for vp in &quot;${vp_values[@]}&quot;; do
        # Format vp value without underscore, just remove the dot
        vp_str=$(echo $vp | tr -d &#39;.&#39;)
        mimi_mass_analysis -p 0.5 -vp $vp -c &quot;$outdir/nat&quot; &quot;$outdir/C13_95&quot; -s &quot;$datadir/$test_file&quot; -o &quot;$outdir/n${base_name}_p05_vp${vp_str}_combined.tsv&quot;
    done
done


echo &quot;Processing complete.&quot;
</pre></div>
</div>
<p>Example output files for testdata1.asc:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ntestdata1_p01_vp05_combined</span><span class="o">.</span><span class="n">tsv</span>    <span class="c1"># p=0.1, vp=0.5</span>
<span class="n">ntestdata1_p05_vp01_combined</span><span class="o">.</span><span class="n">tsv</span>    <span class="c1"># p=0.5, vp=0.1</span>
<span class="n">ntestdata1_p05_vp05_combined</span><span class="o">.</span><span class="n">tsv</span>    <span class="c1"># p=0.5, vp=0.5</span>
<span class="n">ntestdata1_p05_vp1_combined</span><span class="o">.</span><span class="n">tsv</span>     <span class="c1"># p=0.5, vp=1.0</span>
<span class="n">ntestdata1_p1_vp05_combined</span><span class="o">.</span><span class="n">tsv</span>     <span class="c1"># p=1.0, vp=0.5</span>

<span class="n">ntestdata2_p01_vp05_combined</span><span class="o">.</span><span class="n">tsv</span>    <span class="c1"># p=0.1, vp=0.5</span>
<span class="n">ntestdata2_p05_vp01_combined</span><span class="o">.</span><span class="n">tsv</span>    <span class="c1"># p=0.5, vp=0.1</span>
<span class="n">ntestdata2_p05_vp05_combined</span><span class="o">.</span><span class="n">tsv</span>    <span class="c1"># p=0.5, vp=0.5</span>
<span class="n">ntestdata2_p05_vp1_combined</span><span class="o">.</span><span class="n">tsv</span>     <span class="c1"># p=0.5, vp=1.0</span>
<span class="n">ntestdata2_p1_vp05_combined</span><span class="o">.</span><span class="n">tsv</span>     <span class="c1"># p=1.0, vp=0.5</span>
</pre></div>
</div>
<p>This comprehensive analysis approach helps you:</p>
<ul class="simple">
<li><p>Find optimal parameter combinations for your data</p></li>
<li><p>Compare results across different parameter settings</p></li>
<li><p>Generate multiple result sets for further analysis</p></li>
<li><p>Validate the robustness of your compound identifications</p></li>
</ul>
<section id="plotting-the-results">
<h3>Plotting the results<a class="headerlink" href="#plotting-the-results" title="Permalink to this headline"></a></h3>
<p>To plot the results, you can use the following command:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$python scripts/plot_results.py  outdir/
</pre></div>
</div>
</section>
</section>
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline"></a></h2>
<ol class="arabic simple">
<li><p><strong>Data Quality</strong>:</p>
<ul class="simple">
<li><p>Always combine mass accuracy with isotope pattern matching</p></li>
<li><p>Compare results from natural and labeled caches</p></li>
<li><p>Process replicates together for consistency</p></li>
<li><p>Verify important matches manually</p></li>
</ul>
</li>
<li><p><strong>Common Issues and Solutions</strong>:</p>
<ul class="simple">
<li><p><strong>No matches found</strong>:</p>
<ul>
<li><p>Increase PPM threshold</p></li>
<li><p>Verify sample format</p></li>
<li><p>Check ionization mode</p></li>
</ul>
</li>
<li><p><strong>Too many matches</strong>:</p>
<ul>
<li><p>Decrease PPM threshold</p></li>
<li><p>Use stricter verification PPM</p></li>
<li><p>Filter by isotope score</p></li>
</ul>
</li>
<li><p><strong>Cache creation errors</strong>:</p>
<ul>
<li><p>Verify chemical formulas</p></li>
<li><p>Check labeling configuration</p></li>
<li><p>Enable debugging</p></li>
</ul>
</li>
<li><p><strong>Performance issues</strong>:</p>
<ul>
<li><p>Use focused databases</p></li>
<li><p>Process samples in smaller batches</p></li>
<li><p>Optimize mass ranges</p></li>
</ul>
</li>
</ul>
</li>
</ol>
</section>
<section id="complete-example">
<h2>Complete Example<a class="headerlink" href="#complete-example" title="Permalink to this headline"></a></h2>
<p>Here’s a complete example from start to finish:</p>
<ol class="arabic">
<li><p>First, extract compounds from KEGG within your desired mass range:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mimi_kegg_extract</span> <span class="o">-</span><span class="n">l</span> <span class="mi">40</span> <span class="o">-</span><span class="n">u</span> <span class="mi">1000</span> <span class="o">-</span><span class="n">o</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">kegg_compounds_40_1000Da</span><span class="o">.</span><span class="n">tsv</span>

<span class="c1"># Sort and remove duplicates from KEGG compounds file</span>
<span class="p">{</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">1</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">kegg_compounds_40_1000Da</span><span class="o">.</span><span class="n">tsv</span><span class="p">;</span> <span class="n">tail</span> <span class="o">-</span><span class="n">n</span> <span class="o">+</span><span class="mi">2</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">kegg_compounds_40_1000Da</span><span class="o">.</span><span class="n">tsv</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">k2</span><span class="p">,</span><span class="mi">2</span><span class="p">;</span> <span class="p">}</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">kegg_compounds_40_1000Da_sorted</span><span class="o">.</span><span class="n">tsv</span>
<span class="n">awk</span> <span class="s1">&#39;!seen[$1]++&#39;</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">kegg_compounds_40_1000Da_sorted</span><span class="o">.</span><span class="n">tsv</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">kegg_compounds_40_1000Da_sorted_uniq</span><span class="o">.</span><span class="n">tsv</span>
</pre></div>
</div>
</li>
<li><p>Create both natural abundance and C13-95% labeled caches:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Natural abundance</span>
<span class="n">mimi_cache_create</span> <span class="o">-</span><span class="n">i</span> <span class="n">neg</span> <span class="o">-</span><span class="n">d</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">kegg_compounds_40_1000Da_sorted_uniq</span><span class="o">.</span><span class="n">tsv</span> <span class="o">-</span><span class="n">c</span> <span class="n">outdir</span><span class="o">/</span><span class="n">nat</span>

<span class="c1"># C13-95% labeled</span>
<span class="n">mimi_cache_create</span> <span class="o">-</span><span class="n">i</span> <span class="n">neg</span> <span class="o">-</span><span class="n">l</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">C13_95</span><span class="o">.</span><span class="n">json</span> <span class="o">-</span><span class="n">d</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">kegg_compounds_40_1000Da_sorted_uniq</span><span class="o">.</span><span class="n">tsv</span> <span class="o">-</span><span class="n">c</span> <span class="n">outdir</span><span class="o">/</span><span class="n">C13_95</span>
</pre></div>
</div>
</li>
<li><p>Verify the cache contents to ensure everything was processed correctly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mimi_cache_dump</span> <span class="n">outdir</span><span class="o">/</span><span class="n">nat</span><span class="o">.</span><span class="n">pkl</span> <span class="o">-</span><span class="n">n</span> <span class="mi">2</span> <span class="o">-</span><span class="n">i</span> <span class="mi">2</span>
</pre></div>
</div>
</li>
<li><p>Finally, analyze your sample using both caches:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mimi_mass_analysis</span> <span class="o">-</span><span class="n">p</span> <span class="mf">1.0</span> <span class="o">-</span><span class="n">vp</span> <span class="mf">1.0</span> <span class="o">-</span><span class="n">c</span> <span class="n">outdir</span><span class="o">/</span><span class="n">nat</span> <span class="n">outdir</span><span class="o">/</span><span class="n">C13_95</span> <span class="o">-</span><span class="n">s</span> <span class="n">data</span><span class="o">/</span><span class="n">processed</span><span class="o">/</span><span class="n">testdata2</span><span class="o">.</span><span class="n">asc</span> <span class="o">-</span><span class="n">o</span> <span class="n">outdir</span><span class="o">/</span><span class="n">results</span><span class="o">.</span><span class="n">tsv</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="MIMI Documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="architecture.html" class="btn btn-neutral float-right" title="Architecture Design" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Nabil Rahiman.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>